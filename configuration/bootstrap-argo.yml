---
- name: Argo
  hosts: jh
  become: true
  gather_facts: false
  tasks:
    - name: Create ArgoCD namespace
      shell: kubectl create namespace argocd
      environment:
        KUBECONFIG: /home/user/.kube/config
      ignore_errors: true

    - name: Install HA ArgoCD
      shell: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/ha/install.yaml
      environment:
        KUBECONFIG: /home/user/.kube/config

    - name: Run a shell command and register its output as a variable
      uri:
        url: https://api.github.com/repos/argoproj/argo-cd/releases/latest
        return_content: true
        body_format: json
      register: argocd_latest_version

#    - name: Detect current latest ArgoCD version
#      shell: curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/'
#      register: argocd_latest_version

    - name: Current latest ArgoCD version
      debug: msg={{ argocd_latest_version.stdout.tag_name }}

    - name: Download ArgoCD binary
      get_url:
        url: "https://github.com/argoproj/argo-cd/releases/download/{{ argocd_version }}/argocd-linux-amd64"
        dest: /usr/local/bin/argocd
        mode: 0755

