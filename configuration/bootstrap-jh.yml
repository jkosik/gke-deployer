---
- name: Disable unattended updates
  hosts: jh
  become: true
  gather_facts: false
  vars:
    - apt_unattended_updates_state: "disabled"
  roles:
    - ansible-apt

- name: Install packages and copy files
  hosts: jh
  become: true
  gather_facts: true
  tasks:
    - name: Install packages
      apt:
        state: present
        update_cache: true
        name:
          - curl
          - dnsutils
          - git
          - jq
          - wget

    - name: Create jumphost directory
      file:
        path: /home/user/jumphost
        state: directory

    - name: Copy Terraform vars to jumphost
      copy:
        src: "{{ playbook_dir }}/../infrastructure/{{ infra_env }}.tfvars"
        dest: "/home/user/jumphost"

    - name: Create directory for sample k8s manifests
      file:
        path: /home/user/jumphost/manifest
        state: directory

    - name: Copy sample k8s manifests
      copy:
        src: jumphost/manifests
        dest: "/home/user/jumphost/manifest"

    - name: Set permissions
      file:
        path: "/home/user/jumphost"
        recurse: true
        owner: "user"
        group: "user"


- name: Install kubectl and get kubeconfig
  hosts: jh
  become: true
  gather_facts: false
  tasks:
    - name: Run a shell command and register its output as a variable
      uri:
        url: https://dl.k8s.io/release/stable.txt
        return_content: true
      register: k8s_stable_version

    - name: Current stable kubectl version
      debug: msg={{ k8s_stable_version.content }}

    - name: Download kubectl binary
      get_url:
        url: "https://dl.k8s.io/release/{{ k8s_stable_version.content }}/bin/linux/amd64/kubectl"
        dest: /opt
        mode: 0440

    - name: Install kubectl
      shell: |
        install -o root -g root -m 0755 /opt/kubectl /usr/local/bin/kubectl
        mkdir -p ~/.local/bin/kubectl
        mv /opt/kubectl ~/.local/bin/kubectl

    - name: Install bash-completion
      apt:
        state: present
        update_cache: yes
        name:
          - bash-completion

    - name: Configure kubectl command completition
      shell: |
        source /usr/share/bash-completion/bash_completion
        echo 'source <(kubectl completion bash)' >>~/.bashrc

    - name: Create /home/user/.kube directory
      file:
        path: /home/user/.kube
        state: directory
        owner: user
        group: user

    - name: Remove file (delete file)
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /home/user/.kube/config
        - /root/.kube/config

    - name: Grab and import kubeconfig to user "user" homedir
      become_user: user
      shell: |
        PROJECT_ID=$(cat /home/user/jumphost/{{ infra_env }}.tfvars | grep project_id | cut -d\" -f2)
        ZONE=$(cat /home/user/jumphost/{{ infra_env }}.tfvars | grep zone | cut -d\" -f2)
        GKE_CLUSTER_NAME=$(cat /home/user/jumphost/{{ infra_env }}.tfvars | grep gke_cluster_name | cut -d\" -f2)
        gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $ZONE --project $PROJECT_ID --internal-ip
        if gcloud secrets describe kubeconfig-$GKE_CLUSTER_NAME; then
          echo "Secret kubeconfig-$GKE_CLUSTER_NAME already exists."
        else
          gcloud secrets create kubeconfig-$GKE_CLUSTER_NAME --data-file=/home/user/.kube/config --labels=owner=dso,info=jumphost-generated
        fi